# Socket通信(Java)

## Socket通信の基本の流れ
### 1. サーバー側
1. `ServerSocket`を宣言する
2. クライアントのコネクションを待機する
3. ストリームを介してクライアントからのデータ情報を読み込む
4. ストリームを介してクライアントへデータ情報を書き込む

### 2. クライアント側
1. `Socket`をインスタンス化しIPとPortを設定する
2. ストリームのインスタンスを作成する
3. ストリームを介してサーバーにデータ情報を書き込む
4. ストリームを介してサーバーからの返信を受け取る．

![image](./Socket通信(Java)のフロー.dio.svg)

## ブロッキングI/Oと非ブロッキングI/O
[[Java]]では，[[Socket通信]]の種類によって異なるクラスを提供している．

| 分類 | 用途                     | ブロッキングI/O           | 非ブロッキングI/O                       |
| ---- | ------------------------ | ------------------------- | --------------------------------------- |
| TCP  | サーバーのポートバインド | `java.net.ServerSocket`   | `java.nio.channels.ServerSocketChannel` |
| TCP  | ソケット通信             | `java.net.Socket`         | `java.nio.channels.SocketChannel`       |
| UDP  | ソケット通信             | `java.net.DatagramSocket` | `java.nio.cnannels.DatagramChannnel`    |

それぞれの方式について以下の特徴がある．

|                            | ブロッキングI/O | 非ブロッキングI/O  |
| -------------------------- | --------------- | ------------------ |
| thread辺りのsocket数       | 1               | 多(selectorで管理) |
| データの書込み先(読取り元) | Stream          | Buffer             |
|                            |                 |                    |

ブロッキングI/O方式では，1スレッド内で1つのSocketを用いた通信しかできないが，
非ブロッキングI/Oでは，Selectorによる接続監視により複数のSocket通信を1スレッド内で処理できる．

ブロッキングI/Oでの処理フロー
| No  | Client             |     | Server                                 | 備考 |
| --- | ------------------ | :-: | -------------------------------------- | ---- |
| 1   |                    |     | `ServerSocket`インスタンス化とバインド |      |
| 2   |                    |     | 接続待機                               |      |
| 3   | `Socket`生成と接続 |  ⇒  | 接続確認と`Socket`生成                 |      |
| 4   | ストリームの生成   |     | ストリームの生成                       |      |
| 5   | データの書込み     |  ⇒  | データの読み込み                       |      |
| 6   | データの読み込み   |  ⇐  | データの書込み                         |      |

非ブロッキングI/Oでの処理フロー
| No   |          Client           |     |                Server                | 備考 |
| ---- | :-----------------------: | :-: | :----------------------------------: | ---- |
| 1    |                           |     |  `Selector`インスタンス化とバインド  |      |
| 2    |                           |     | `ServerSocketChannel`インスタンス化  |      |
| 3    |                           |     |           `Selector`に登録           |      |
| 4    |                           |     |               接続待機               |      |
| 5    | `SocketChannel`生成と接続 |  ⇒  |      `Selector`の一部が`select`      |      |
| 6    |                           |     |      `select`された`key`を確認       |      |
| 7    |                           |     | --- <Acceptableなselectorの処理> --- |      |
| 7-1  |                           |     |     `isAcceptable`な`key`を取得      |      |
| 7-2  |                           |     |         `SocketChannel`生成          |      |
| 7-3  |                           |     |           `Selector`に登録           |      |
| -    |                           |     |   -------------------------------    |      |
| 8    |      バッファの設定       |     |                                      |      |
| 9    |     バッファに書込み      |  ⇒  |    `Selector`の一部が`isReadable`    |      |
| 10   |                           |     | --- <isReadableなselectorの処理> --- |      |
| 10-1 |                           |     |             `key`を取得              |      |
| 10-2 |                           |     |            バッファを設定            |      |
| 10-3 |                           |     |          バッファに読み込み          |      |
| 10-4 |                           |     |              変数に格納              |      |
| -    |                           |     |   -------------------------------    |      |
| 11   |                           |     | --- <isWritableなselectorの処理> --- |      |
| 11-1 |                           |     |             `key`を取得              |      |
| 11-2 |                           |     |            バッファを設定            |      |
| 11-3 |      バッファを設定       |  ⇐  |           バッファに書込み           |      |
| 11-4 |    バッファに読み込み     |     |                                      |      |
| 11-5 |        変数に格納         |     |                                      |      |
| -    |                           |     |   -------------------------------    |      |



## 参考
- Medium: [ブロッキングI/Oと非ブロッキングI/O](https://medium.com/coderscorner/tale-of-client-server-and-socket-a6ef54a74763)
- Qiita: [6.1 TCPとUDPによるネットワーク（ソケット、チャネル、ServerSocketChannel、SocketChannel、ByteBuffer、ノンブロッキングI/O、セレクタなど）～Java Advanced編](https://qiita.com/KenyaSaitoh/items/b9f8b3d188cc67c62da1)

[//begin]: # "Autogenerated link references for markdown compatibility"
[Java]: Java.md "Java"
[//end]: # "Autogenerated link references"